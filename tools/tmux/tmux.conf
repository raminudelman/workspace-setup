############################################################
###                    General Notes                     ###  
############################################################

#   * "M" key is "Meta" key which is the "Alt" key
#   * "C" key is "Ctrl" key
#   * "S" key is "Shift" key
#   * "set" is alias for "set-option"
#   * "set -g" is used to set global options
#   * "set -a" is used to append to the option (vs. setting when using `set -g`)
#   * "setw" is alias for "set-window-option"
#   * "bind-key <key> <command>" means that first need to press the tmux prefix (by default "C-b") and the press the <key> to execute the command <command>
#   * "bind-key -n <key> <command>" means that no tmux prefix should be pressed before the <key> to execute the command <command> 
#
# Some more info about tmux config options:
#   * https://stackoverflow.com/questions/38967247/tmux-how-do-i-bind-function-keys-to-commands
#   * https://superuser.com/questions/758843/difference-between-global-server-session-and-window-options 
#

############################################################
###                     Copy Mode                        ###  
############################################################

# The tmux selection is the one involved when you enter copy mode. 
# 
# First enter into copy mode using 'Ctrl-b [', and then:
#
# In emacs mode, use 'C-Space' to mark the selection, then use the movement
# keys to define the area. The contents are copied using 'Alt-w'. You can
# paste the contents by pressing 'Ctrl-b ]'.
#
# In `vi` mode entering copy mode allows you to copy text or view the history
# of the buffer, including searching with '/' and '?'. Most of the basic vi
# movements work, including screenwise vertical movement commands like 'Ctrl-f'
# and 'Ctrl-b'. You can leave this mode just by pressing 'Enter', or you can 
# start a selection by pressing 'Space' on a character, moving to another, and
# then pressing 'Enter'. If you have text copied like this you can paste it 
# into any tmux window in that session by pressing 'Ctrl-b' and then ']'.
#
# Note: After pressing 'Space' you can switch to Visual mode in vi so the
#       selection is done in "block mode" or using multiple cursers. Copying is
#       done as usual using 'Ctrl-b' and then ']'
#
# Setting copy-mode to 'vi' mode (default is 'emacs')
set-window-option -g mode-keys vi

# Key bindings in tmux command prompt (prefix + :)
# The following keys have a special meaning in the command
# prompt, depending on the value of the status-keys option:
#     Function                             vi        emacs
#     ------------------------------------------------------
#     Cancel command prompt                q         Escape
#     Delete from cursor to start of word            C-w
#     Delete entire command                d         C-u
#     Delete from cursor to end            D         C-k
#     Execute command                      Enter     Enter
#     Get next command from history                  Down
#     Get previous command from history              Up
#     Insert top paste buffer              p         C-y
#     Look for completions                 Tab       Tab
#     Move cursor left                     h         Left
#     Move cursor right                    l         Right
#     Move cursor to end                   $         C-e
#     Move cursor to next word             w         M-f
#     Move cursor to previous word         b         M-b
#     Move cursor to start                 0         C-a
#     Transpose characters                           C-t
set-option -g status-keys vi

# Make 'v' start a selection and 'y' finish it in the same way that 'Space' 
# and 'Enter' do in Vim
# Note These binding do not work probably because of tmux-yank plugin
#bind-key -T copy-mode-vi 'v' send -X begin-selection
#bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel
#bind-key -T copy-mode-vi 'y' send -X copy-pipe

# Exit copy-mode when stuck
# https://unix.stackexchange.com/questions/423643/tmux-stuck-in-copy-mode
bind-key -T copy-mode C-c send-keys -X cancel

############################################################
###                  General Settings                    ###  
############################################################

# Making Tmux to number windows/panes starting from 1 and not 0 for less
# fingers "stretching" to get to the first item
set-option -g base-index 1
set-window-option -g pane-base-index 1

# Automatically set window title
set-window-option -g automatic-rename on
set-option -g set-titles on

# Ensure window index numbers get reordered upon windows closure.
set-option -g renumber-windows on

# Scrollback lines
set-option -g history-limit 100000

# Disable automatic rename of newly created windows
set-option -g allow-rename off

# Allows tmux to monitor for command/process exits
set-window-option -g monitor-activity on

# Enables multiple panes in one window, to receive the same keyboard input
# Press: Tmux prefix and then @ to start synchronization and press again to turn it off
bind-key @ setw synchronize-panes

# Rather than constraining window size to the maximum size of any client 
# connected to the *session*, constrain window size to the maximum size of any 
# client connected to *that window*. Much more reasonable.
# Source: 
#    * https://mutelight.org/practical-tmux#section-5
#    * https://mutelight.org/practical-tmux#section-7
# TODO: Seems like it does not work on Gnome Terminal in Tmux 3.0a
set-window-option -g aggressive-resize on

############################################################
###                      Notes.md                        ###  
############################################################

# Quickly edit notes
#bind-key t split-window -h "vim ~/notes.md"

############################################################
###                    Mouse Control                     ###  
############################################################

# Enable mouse control:
# Clickable windows, panes, resizable panes
set-option -g mouse on

# Selecting with mouse spans over panes when mouse is on.
# The following keyboard shortcuts allow to turn on/off the mouse
# to enable proper text selection within Tmux
#
# Source: https://unix.stackexchange.com/questions/478922/tmux-select-and-copy-pane-text-with-mouse
#
# Toggle mouse on
#bind-key M \
#  set-option -g mouse on \;\
#  display-message 'Mouse: ON'

# Toggle mouse off
#bind-key m \
#  set-option -g mouse off \;\
#  display-message 'Mouse: OFF'

############################################################
###                    "Escape" Key                      ###  
############################################################

# No delay for "Escape" key press
# From the manual pages:
# "Set the time in milliseconds for which tmux waits after
# an escape is input to determine if it is part of a
# function or meta key sequences. The default
# is 500 milliseconds.
# Setting to 0 does not work: https://github.com/microsoft/WSL/issues/5931
set-option -sg escape-time 50

############################################################
###                     Status Bar                       ###  
############################################################

# https://jonasjacek.github.io/colors/
# https://arcolinux.com/everything-you-need-to-know-about-tmux-status-bar/

GREY="#808080"
BLUE="#569CD6"
DARK_BLUE="#223E55"
RED="#EE4646"
YELLOW="#CCCC99"
BACKGROUND="#000000"
FOREGROUND="#CCCCCC"

# Status bar background
# `default` makes the background transparent
set-option -g status-style bg=default 

# Current window name text (foreground)
set-window-option -g window-status-current-style fg=$BLUE

# In-active windows are colored (foreground) in grey to make it easier
# to differentiate them from the color of the active window and all other
# information in the status bar.
set-window-option -g window-status-style fg=$GREY

# `default` is reverse which reverses the 'bg' color with the 'fg' color
set-window-option -g window-status-activity none

# When a command exits in a non-active window, visually change the tab list to reflect that
# when turned on, the whole status bar "blinks" one time with a message
# that says which window has some activity
set-window-option -g visual-activity off

# When there is activity in some non-focused window, turn the window name to red
set-window-option -g window-status-activity-style fg=$RED

# Update the status bar every 5 seconds
set-option -g status-interval 5

# Increase the length of status bar, or the characters won't fit
set -g status-left-length 85

# On the left-side of status in white: print '{session_name} | [{user}@{hostname}] | '
#set -g status-left '#[fg=white]#S | [#(whoami)@#H]#[default] | '

# On the left-side of status in bold white: print '{session_name} | '
set -g status-left '#[fg=white,bold]#S | '


############################################################
###                     Tmux Prefix                      ###  
############################################################

# Remap the default prefix 'C-b' to 'C-k'
# unbind C-b
# set-option -g prefix C-k
# bind-key C-k send-prefix

############################################################
###                     Split Panes                      ###
############################################################

# Split panes using '|' ("pipe") and '-' ("minus"/"dash")
# and the new panes will be opened in the same current path
# Unbind the original binding for spliting windows '"' and '%'

# Vertical split
bind-key | split-window -h -c '#{pane_current_path}' 
unbind '"'

# Horizontal split
bind-key - split-window -v -c '#{pane_current_path}' 
unbind %

############################################################
###                     Panes style                      ###
############################################################

# Pane divider style
set-option -g pane-active-border-style bg=default,fg=green
set-option -g pane-border-style bg=default,fg=grey


############################################################
###                     Resize Panes                     ###  
############################################################

# Use "Vim Style Arrow" keys with prefix key to resize panes
bind-key j resize-pane -D 15 # Down 15 cells
bind-key k resize-pane -U 15 # Up 15 cells
bind-key h resize-pane -L 15 # Left 15 cells
bind-key l resize-pane -R 15 # Right 15 cells

# Use Alt+"Vim Style Arrow" keys without prefix key to resize panes
bind-key -n M-j resize-pane -D 15 # Down 15 cells
bind-key -n M-k resize-pane -U 15 # Up 15 cells
bind-key -n M-h resize-pane -L 15 # Left 15 cells
bind-key -n M-l resize-pane -R 15 # Right 15 cells

############################################################
###                    Panes Selection                   ###  
############################################################

# Use Alt+Arrow keys without prefix key to switch panes
bind-key -n M-Left select-pane -L
bind-key -n M-Right select-pane -R
bind-key -n M-Up select-pane -U
bind-key -n M-Down select-pane -D

# Use Alt+vim keys without prefix key to switch panes
bind-key -n M-h select-pane -L # Left
bind-key -n M-j select-pane -D # Down
bind-key -n M-k select-pane -U # Up
bind-key -n M-l select-pane -R # Right

# Although the tmux authors have done an amazing job with defining a simple 
# and consistent interface, at times a command may be a bit much to remember or
# type. Luckily, we can make use of the command-prompt tmux command, which 
# takes a prompt string and a command template string, and can interpolate the
# output of the prompt into the command by replacing the place holder value %%.
# This binds `prefix + m` and `prefix + M` to merge panes to and from,
# a specific window, respectively.
#bind-key m command-prompt -p "Merge pane to:"  "join-pane -t '%%'"
#bind-key M command-prompt -p "Merge pane from:"  "join-pane -s '%%'"

# Bound `prefix + h` to highlight the borders of the current pane.
#bind-key h select-pane -m

############################################################
###                  Open/Close Windows                  ###  
############################################################

# Open new window using C-t (like opening a new tab in a web browser)
# Note: This shortcut comes in addition to the `prefix + c` shortcut
bind-key -n C-t new-window

# Close current window using C-w (like closing a tab in a web browser).
# Note: C-w does not ask for confirmatio like `prefix + x` does and simply
#       closes the window immediately.
# Note: This shortcut comes in addition to the `prefix + x` shortcut
bind-key C-w kill-window

############################################################
###                Cycle Between Windows                 ###  
############################################################

# Switch to previous/next windows
# Use `Alt + ,` for previous window and `Alt + .` for next window
bind-key -n M-, previous-window
bind-key -n M-. next-window

# TODO: Try to bind Ctrl+Tab for window cycling. Use 'Tab' and 'BTab'
# Source: https://stackoverflow.com/questions/38967247/tmux-how-do-i-bind-function-keys-to-commands

############################################################
###                    Move Windows                      ###  
############################################################

bind-key -n M-[ swap-window -t -1 # Move window left
bind-key -n M-] swap-window -t +1 # Move window right

# Bound C-PageUp and C-PageDown, to switch windows, backwards and forwards,
# respectively. We also bound S-Left and S-Right, to swap windows to the left
# and to the right, respectively.
#bind -n C-PPage previous-window
#bind -n C-NPage next-window
#bind -n S-left swap-window -t -1
#bind -n S-right swap-window -t +1

############################################################
###                 Search In Copy Mode                  ###  
############################################################

# Enter copy mode and start searching downward in one go
# using prefix + /
# bind-key / copy-mode \; send-key C-s ## Conflict with save-session of tmux-resurrect

# Enter copy mode and start searching upward in one go
# using prefix + ?
# bind-key ? copy-mode \; send-key C-r ## Conflict with restore-session of tmux-resurrect

############################################################
###                 Tmux Config Reload                   ###  
############################################################

# Reload the tmux config file using 'r' key
unbind r
bind-key r source-file ~/.config/tmux/tmux.conf \; display "Reloaded ~/.tmux.conf"

############################################################
###                    Tmux Plugins                      ###  
############################################################

# -----------------------------------------------------------------------------
# Tmux Plugin Manager (TPM) - https://github.com/tmux-plugins/tpm
# In order to use the plugins below you need to install TPM and the plugins.
#   Step 1) git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
#   Step 2) Reload tmux if it's already started with 'prefix + r'
#   Step 3) Launch tmux and hit 'prefix + I' (capital i) to install any plugins
#
# Note: Use 'prefix + I' to update existing plugins.
#
# How to delete a plugin?
#    1. Delete or comment out the plugin in .tmux.conf
#    2. Press `prefix + alt + u` to remove the plugin
#
# To automatically install tmux tpm on new machines you can use
# if "test ! -d ~/.tmux/plugins/tpm" \
#   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && \
#   ~/.tmux/plugins/tpm/bin/install_plugins'"
# -----------------------------------------------------------------------------
# More cool Tmux plugins:
#   https://github.com/rothgar/awesome-tmux
#   https://github.com/tmux-plugins
#   https://github.com/jimeh/tmux-themepack

# List of plugins.

# The plugin manager itself.
set -g @plugin 'tmux-plugins/tpm'

# Provides two key bindings for save and restore your tmux environment:
# Save:    <prefix> + Ctrl-s
# Restore: <prefix> + Ctrl-r
set -g @plugin 'tmux-plugins/tmux-resurrect'

# Complements tmux-resurrect by automatically restoring sessions
# on your initial tmux start up.
# This plugin requires tmux-resurrect plugin to be also installed.
# set -g @plugin 'tmux-plugins/tmux-continuum'

# Restore last saved environment automatically when tmux is started.
# set -g @continuum-restore 'on'

# tmux-colors-solarized is a solarized color theme for tmux.
# Link: https://github.com/seebi/tmux-colors-solarized
# Four themes are provided: 256, dark, light and base16.
# You can choose one via .tmux.conf option:
#
# set -g @colors-solarized '256'
# set -g @colors-solarized 'dark'
# set -g @colors-solarized 'light'
# set -g @colors-solarized 'base16'
#
#set -g @plugin 'seebi/tmux-colors-solarized'
#set -g @colors-solarized 'dark'

# How to use: https://github.com/tmux-plugins/tmux-yank
#
# ## Requirements
# In order for tmux-yank to work, there must be a program that store data in 
# the system clipboard.
#
# ### Linux
#
# `xsel` (recommended) or `xclip` (for X).
# `wl-copy` from wl-clipboard (for Wayland)
# If you have `tmux` 1.5 or newer and are using `xterm`, the `y` in `copy-mode`
# and mouse selection will work without `tmux-yank`. See the `tmux(1)` man page
# entry for the `set-clipboard` option.
#
# #### Debian & Ubuntu
#
# `$ sudo apt-get install xsel # or xclip`
#
# #### RedHat & CentOS
#
# `$ sudo yum install xsel # or xclip`
#
# ## Key bindings
#
# ### Normal Mode
#
#    * `prefix-y` — copies text from the command line to the clipboard.
#                   Works with all popular shells/repls. Tested with:
#                   * shells: bash, zsh (with bindkey -e), tcsh
#                   * repls: irb, pry, node, psql, python, php -a, coffee
#                   * remote shells: ssh, mosh
#                   * vim/neovim command line (requires vim-husk or vim-rsi 
#                     plugin)
#
#    * `prefix-Y` — copy the current pane’s current working directory to the 
#                   clipboard.
#
# ### Copy Mode
#
#    * `y`           — copy selection to system clipboard.
#    * `Y` (shift-y) — “put” selection. Equivalent to copying a selection, 
#                       and pasting it to the command line.
#set -g @plugin 'tmux-plugins/tmux-yank'

# Source: 
#    * https://github.com/tmux/tmux/issues/140
#    * https://stackoverflow.com/questions/32374907/tmux-mouse-copy-mode-jumps-to-bottom
# tmux-yank will exit copy mode after yanking text (which done, among other
# methods using selecting text using the clicking the mouse to select text
# and releasing the mouse). If you wish to remain in copy mode, you can set 
# @yank_action:
#set -g @yank_action 'copy-pipe' # or 'copy-pipe-and-cancel' for the default

# Source: 
#    * https://stackoverflow.com/questions/32374907/tmux-mouse-copy-mode-jumps-to-bottom
#    * https://github.com/tmux/tmux/issues/140
unbind -T copy-mode-vi MouseDragEnd1Pane

# https://github.com/tmux-plugins/tmux-copycat
set -g @plugin 'tmux-plugins/tmux-copycat'

# https://github.com/tmux-plugins/tmux-open
set -g @plugin 'tmux-plugins/tmux-open'

# Load other Tmux local plugins file
if-shell "[ -f ~/.config/tmux/tmux.conf.local_plugins ]" 'source ~/.config/tmux/tmux.conf.local_plugins'

############################################################
###          Tmux Other Config Settings Files            ###  
############################################################

# Load other Tmux local configuration file
if-shell "[ -f ~/.config/tmux/tmux.conf.local ]" 'source ~/.config/tmux/tmux.conf.local'

############################################################
###          Tmux plugin manager - KEEP LAST             ###  
############################################################

# Runs the Tmux plugin manager (TPM)
# Note: keep this line at the very bottom of your tmux.conf file.
run -b '~/.config/tmux/plugins/tpm/tpm'